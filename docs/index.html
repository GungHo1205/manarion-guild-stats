<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guild Stats Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
      :root {
        --bg-primary: #0a0a0b;
        --bg-secondary: #1a1a1b;
        --bg-tertiary: #2a2a2b;
        --text-primary: #f8f9fa;
        --text-secondary: #b3b3b3;
        --accent: #4a9eff;
        --accent-hover: #3a8eef;
        --border: #3a3a3b;
        --shadow: rgba(0, 0, 0, 0.5);
        --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 0;
        background: var(--bg-secondary);
        border-radius: 20px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 30px var(--shadow);
      }
      .header h1 {
        font-size: 3rem;
        font-weight: 800;
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }
      .header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
      }
      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 5px 20px var(--shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px var(--shadow);
      }
      .stat-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .stat-card.total-guilds h3 {
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .stat-card.avg-nexus h3 {
        background: var(--gradient-2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .stat-card.avg-study h3 {
        background: var(--gradient-3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .stat-card.levels-gained h3 {
        background: linear-gradient(
          135deg,
          #ff9a9e 0%,
          #fecfef 50%,
          #fecfef 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .stat-card.dust-spending h3,
      .stat-card.codex-spending h3 {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .dust-price {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 8px;
        font-weight: 500;
      }
      .progress-indicator {
        display: block;
        margin-top: 5px;
        font-size: 0.8rem;
        opacity: 0.8;
      }
      .progress-positive {
        color: #4ade80;
      }
      .progress-negative {
        color: #f87171;
      }
      .progress-neutral {
        color: var(--text-secondary);
      }
      .stat-card p {
        color: var(--text-secondary);
        font-size: 1rem;
      }
      .controls {
        margin-bottom: 30px;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }
      .search-box {
        flex: 1;
        max-width: 300px;
        position: relative;
      }
      .search-box input {
        width: 100%;
        padding: 12px 20px 12px 45px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      .search-box input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
      }
      .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
      }
      .last-update {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-left: auto;
      }
      .guild-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
      }
      .guild-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px var(--shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .guild-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-1);
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .guild-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 50px var(--shadow);
        border-color: var(--accent);
      }
      .guild-card:hover::before {
        opacity: 1;
      }
      .guild-name {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text-primary);
        word-break: break-word;
      }
      .level-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
      }
      .level-item {
        text-align: center;
        flex: 1;
      }
      .level-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      .level-value {
        font-size: 2rem;
        font-weight: 700;
        margin-top: 5px;
      }
      .nexus-level {
        background: var(--gradient-2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .study-level {
        background: var(--gradient-3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .daily-change {
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 3px;
        padding: 2px 6px;
        border-radius: 4px;
        text-align: center;
        line-height: 1.2;
      }
      .daily-change.positive {
        background: rgba(74, 222, 128, 0.1);
        color: #4ade80;
      }
      .daily-change.negative {
        background: rgba(248, 113, 113, 0.1);
        color: #f87171;
      }
      .daily-change.neutral {
        background: rgba(179, 179, 179, 0.1);
        color: var(--text-secondary);
      }
      .loading {
        text-align: center;
        padding: 60px;
        color: var(--text-secondary);
      }
      .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        background: #2d1b1b;
        border: 1px solid #5c2d2d;
        color: #ff6b6b;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin: 20px 0;
      }
      .navbar {
        background: var(--bg-secondary);
        padding: 10px 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        display: flex;
        justify-content: center;
        border: 1px solid var(--border);
        flex-wrap: wrap;
      }
      .nav-link {
        color: var(--text-primary);
        text-decoration: none;
        padding: 10px 15px;
        margin: 5px;
        border-radius: 8px;
        transition: background-color 0.3s;
        font-weight: 500;
        cursor: pointer;
      }
      .nav-link:hover,
      .nav-link.active {
        background-color: var(--accent);
        color: var(--bg-primary);
      }
      .chart-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
        padding: 0 10px;
      }
      .chart-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
      }
      .chart-controls label {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-right: 10px;
      }
      .chart-controls button {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
      }
      .chart-controls button:hover {
        border-color: var(--accent);
      }
      .chart-controls button.active {
        background-color: var(--accent);
        border-color: var(--accent-hover);
        color: var(--bg-primary);
        font-weight: bold;
      }
      .chart-container {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 25px;
        margin-top: 40px;
        border: 1px solid var(--border);
        box-shadow: 0 5px 20px var(--shadow);
      }
      .chart-canvas-container {
        position: relative;
        height: 400px;
        margin-top: 20px;
      }
      .price-stats {
        margin-top: 20px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .price-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        text-align: center;
      }
      .price-item {
        display: flex;
        flex-direction: column;
      }
      .price-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 5px;
      }
      .price-value {
        font-size: 1.2rem;
        font-weight: bold;
      }
      .price-buy {
        color: #4ade80;
      }
      .price-sell {
        color: #f87171;
      }
      .price-avg {
        color: var(--accent);
      }
      .interval-toggle {
        display: flex;
        background: var(--bg-tertiary);
        border-radius: 8px;
        padding: 2px;
        border: 1px solid var(--border);
      }
      .interval-toggle button {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.85rem;
      }
      .interval-toggle button.active {
        background: var(--accent);
        color: var(--bg-primary);
        font-weight: bold;
      }
      .multiselect-dropdown {
        position: relative;
        display: inline-block;
        min-width: 250px;
      }
      .multiselect-dropdown-btn {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
        width: 100%;
        text-align: left;
      }
      .multiselect-dropdown-list {
        display: none;
        position: absolute;
        background-color: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        min-width: 250px;
        box-shadow: 0 8px 16px 0 var(--shadow);
        z-index: 1;
        max-height: 200px;
        overflow-y: auto;
        padding: 5px;
      }
      .multiselect-dropdown-list label {
        display: block;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
      }
      .multiselect-dropdown-list label:hover {
        background-color: var(--bg-tertiary);
      }
      .multiselect-dropdown-list input[type="checkbox"] {
        margin-right: 10px;
      }
      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }
        .controls,
        .chart-controls {
          flex-direction: column;
          align-items: stretch;
        }
        .search-box {
          max-width: none;
        }
        .guild-grid {
          grid-template-columns: 1fr;
        }
        .nav-link {
          margin: 5px;
          padding: 8px 10px;
        }
        .chart-canvas-container {
          height: 300px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="navbar">
        <a class="nav-link active" data-section="dashboard">Dashboard</a>
        <a class="nav-link" data-section="nexus-charts">Nexus Progress</a>
        <a class="nav-link" data-section="study-charts">Study Progress</a>
        <a class="nav-link" data-section="codex-charts">Codex Prices</a>
      </nav>

      <div id="dashboard" class="page-section">
        <header class="header">
          <h1>Guild Stats Dashboard</h1>
          <p>Real-time guild progression tracking with market data</p>
        </header>
        <div class="stats-overview">
          <div class="stat-card total-guilds">
            <h3 id="totalGuilds">-</h3>
            <p>Total Guilds</p>
          </div>
          <div class="stat-card avg-nexus">
            <h3 id="avgNexus">-</h3>
            <p>Avg Nexus Level</p>
            <small id="avgNexusProgress" class="progress-indicator"></small>
          </div>
          <div class="stat-card avg-study">
            <h3 id="avgStudy">-</h3>
            <p>Avg Study Level</p>
            <small id="avgStudyProgress" class="progress-indicator"></small>
          </div>
          <div class="stat-card levels-gained">
            <h3 id="levelsGained">-</h3>
            <p>Levels Gained Today</p>
            <small id="baselineDate" class="progress-indicator"></small>
          </div>
          <div class="stat-card dust-spending">
            <h3 id="dustSpending">-</h3>
            <p>Daily Dust Spent on Codex</p>
            <div id="dustPrice" class="dust-price">Loading price...</div>
          </div>
        </div>
        <div class="controls">
          <div class="search-box">
            <svg
              class="search-icon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input
              type="text"
              id="searchInput"
              placeholder="Search guilds..."
            />
          </div>
          <div class="last-update" id="lastUpdate">
            Last updated: Loading...
          </div>
        </div>
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Loading guild data...</p>
        </div>
        <div id="error" class="error" style="display: none">
          <p>Failed to load guild data. Please try again later.</p>
        </div>
        <div id="guildGrid" class="guild-grid" style="display: none"></div>
      </div>

      <div id="nexus-charts" class="page-section" style="display: none">
        <div class="chart-container">
          <div class="chart-controls">
            <div class="multiselect-dropdown">
              <button
                id="nexusGuildSelectorBtn"
                class="multiselect-dropdown-btn"
              >
                Select Guilds
              </button>
              <div
                id="nexusGuildSelectorList"
                class="multiselect-dropdown-list"
              ></div>
            </div>
            <div class="interval-toggle">
              <button
                class="guild-interval-btn active"
                data-chart="nexus"
                data-interval="hourly"
              >
                Hourly
              </button>
              <button
                class="guild-interval-btn"
                data-chart="nexus"
                data-interval="daily"
              >
                Daily
              </button>
            </div>
            <div>
              <button
                class="chart-timespan-btn active"
                data-chart="nexus"
                data-hours="24"
              >
                1D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="nexus"
                data-hours="72"
              >
                3D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="nexus"
                data-hours="168"
              >
                7D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="nexus"
                data-hours="336"
              >
                14D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="nexus"
                data-hours="720"
              >
                30D
              </button>
            </div>
          </div>
          <h2 class="chart-title">Nexus Level Progress</h2>
          <div class="chart-canvas-container">
            <canvas id="guildNexusChart"></canvas>
          </div>
        </div>
      </div>

      <div id="study-charts" class="page-section" style="display: none">
        <div class="chart-container">
          <div class="chart-controls">
            <div class="multiselect-dropdown">
              <button
                id="studyGuildSelectorBtn"
                class="multiselect-dropdown-btn"
              >
                Select Guilds
              </button>
              <div
                id="studyGuildSelectorList"
                class="multiselect-dropdown-list"
              ></div>
            </div>
            <div class="interval-toggle">
              <button
                class="guild-interval-btn active"
                data-chart="study"
                data-interval="hourly"
              >
                Hourly
              </button>
              <button
                class="guild-interval-btn"
                data-chart="study"
                data-interval="daily"
              >
                Daily
              </button>
            </div>
            <div>
              <button
                class="chart-timespan-btn active"
                data-chart="study"
                data-hours="24"
              >
                1D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="study"
                data-hours="72"
              >
                3D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="study"
                data-hours="168"
              >
                7D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="study"
                data-hours="336"
              >
                14D
              </button>
              <button
                class="chart-timespan-btn"
                data-chart="study"
                data-hours="720"
              >
                30D
              </button>
            </div>
          </div>
          <h2 class="chart-title">Study Level Progress</h2>
          <div class="chart-canvas-container">
            <canvas id="guildStudyChart"></canvas>
          </div>
        </div>
      </div>

      <div id="codex-charts" class="page-section" style="display: none">
        <div class="chart-container">
          <div class="chart-controls">
            <div>
              <h3 style="color: var(--text-primary); margin: 0">
                Codex Market Prices
              </h3>
            </div>
            <div class="interval-toggle">
              <button class="codex-interval-btn active" data-interval="hourly">
                Hourly
              </button>
              <button class="codex-interval-btn" data-interval="daily">
                Daily
              </button>
            </div>
            <div>
              <button class="codex-timespan-btn active" data-hours="24">
                1D
              </button>
              <button class="codex-timespan-btn" data-hours="72">3D</button>
              <button class="codex-timespan-btn" data-hours="168">7D</button>
              <button class="codex-timespan-btn" data-hours="336">14D</button>
              <button class="codex-timespan-btn" data-hours="720">30D</button>
            </div>
          </div>
          <div class="chart-canvas-container">
            <canvas id="codexPriceChart"></canvas>
          </div>
          <div class="price-stats">
            <div class="price-grid">
              <div class="price-item">
                <div class="price-label">Current Buy Price</div>
                <div id="currentBuyPrice" class="price-value price-buy">-</div>
              </div>
              <div class="price-item">
                <div class="price-label">Current Sell Price</div>
                <div id="currentSellPrice" class="price-value price-sell">
                  -
                </div>
              </div>
              <div class="price-item">
                <div class="price-label">Average Price</div>
                <div id="currentAvgPrice" class="price-value price-avg">-</div>
              </div>
              <div class="price-item">
                <div class="price-label">Daily Change</div>
                <div id="dailyPriceChange" class="price-value">-</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let guildsData = [];
      let filteredData = [];
      let dustData = {};
      let historicalData = {};
      let guildNexusChart = null;
      let guildStudyChart = null;
      let codexChart = null;
      const chartColors = [
        "#f5576c",
        "#4facfe",
        "#4ade80",
        "#f9a8d4",
        "#fde047",
        "#a78bfa",
        "#fb923c",
        "#6ee7b7",
      ];

      document.addEventListener("DOMContentLoaded", () => {
        loadGuildData();
        loadHistoricalData();
        setupNavigation();
        setupChartControls();
        document
          .getElementById("searchInput")
          .addEventListener("input", filterGuilds);
      });

      function setupNavigation() {
        const navLinks = document.querySelectorAll(".nav-link");
        const sections = document.querySelectorAll(".page-section");

        navLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = e.target.getAttribute("data-section");

            navLinks.forEach((l) => l.classList.remove("active"));
            e.target.classList.add("active");

            sections.forEach((s) => (s.style.display = "none"));
            const targetSection = document.getElementById(targetId);
            if (targetSection) targetSection.style.display = "block";

            if (targetId === "nexus-charts") updateChart("nexus");
            if (targetId === "study-charts") updateChart("study");
            if (targetId === "codex-charts") updateCodexChart();

            window.scrollTo({ top: 0 });
          });
        });
      }

      function setupChartControls() {
        // Timespan and Interval buttons
        document
          .querySelectorAll(".chart-timespan-btn, .guild-interval-btn")
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const chartType = e.target.dataset.chart;
              const controlType = e.target.classList.contains(
                "chart-timespan-btn"
              )
                ? "chart-timespan-btn"
                : "guild-interval-btn";
              document
                .querySelectorAll(`#${chartType}-charts .${controlType}.active`)
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              updateChart(chartType);
            });
          });

        document
          .querySelectorAll(".codex-timespan-btn, .codex-interval-btn")
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const controlType = e.target.classList.contains(
                "codex-timespan-btn"
              )
                ? "codex-timespan-btn"
                : "codex-interval-btn";
              document
                .querySelectorAll(`#codex-charts .${controlType}.active`)
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              updateCodexChart();
            });
          });
      }

      async function loadGuildData() {
        try {
          const response = await fetch(
            `./guild-data.json?v=${new Date().getTime()}`
          );
          if (!response.ok) throw new Error("Failed to fetch guild data");
          const data = await response.json();
          guildsData = data.guilds || [];
          filteredData = [...guildsData];
          dustData = data.dustSpending || {};
          updateStats();
          updateLastUpdated(data.lastUpdated, data.baselineDate);
          renderGuilds();
          document.getElementById("loading").style.display = "none";
          document.getElementById("guildGrid").style.display = "grid";
        } catch (error) {
          console.error("Error loading guild data:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("error").style.display = "block";
        }
      }

      async function loadHistoricalData() {
        try {
          const response = await fetch(
            `./historical-data.json?v=${new Date().getTime()}`
          );
          historicalData = response.ok
            ? await response.json()
            : {
                guild_history: {},
                market_prices: { prices: [], daily_averages: {} },
              };
          populateGuildSelector();
          if (document.getElementById("nexus-charts").style.display !== "none")
            updateChart("nexus");
          if (document.getElementById("study-charts").style.display !== "none")
            updateChart("study");
          if (document.getElementById("codex-charts").style.display !== "none")
            updateCodexChart();
          updateCurrentPriceDisplay();
        } catch (error) {
          console.error("Error loading historical data:", error);
          historicalData = {
            guild_history: {},
            market_prices: { prices: [], daily_averages: {} },
          };
          populateGuildSelector();
        }
      }

      function setupMultiSelect(type) {
        const btn = document.getElementById(`${type}GuildSelectorBtn`);
        const list = document.getElementById(`${type}GuildSelectorList`);

        btn.addEventListener("click", () => {
          list.style.display =
            list.style.display === "block" ? "none" : "block";
        });

        list.addEventListener("change", () => updateChart(type));

        // Close dropdown if clicking outside
        document.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !list.contains(e.target)) {
            list.style.display = "none";
          }
        });
      }

      function populateGuildSelector() {
        const guildNames = Object.keys(
          historicalData.guild_history || {}
        ).sort();
        ["nexus", "study"].forEach((type) => {
          const list = document.getElementById(`${type}GuildSelectorList`);
          const btn = document.getElementById(`${type}GuildSelectorBtn`);
          if (!list || !btn) return;

          if (guildNames.length > 0) {
            list.innerHTML = guildNames
              .map(
                (name, index) => `
                    <label>
                        <input type="checkbox" value="${name}" ${
                  index === 0 ? "checked" : ""
                }> ${name}
                    </label>
                `
              )
              .join("");
            btn.textContent = "1 Guild Selected";
          } else {
            list.innerHTML = "<span>No historical data</span>";
            btn.textContent = "No Guilds Available";
          }
          setupMultiSelect(type);
        });
      }

      function updateStats() {
        if (!guildsData || guildsData.length === 0) return;
        document.getElementById("totalGuilds").textContent = guildsData.length;
        const avgNexus =
          guildsData.reduce((sum, g) => sum + (g.NexusLevel || 0), 0) /
          guildsData.length;
        const avgStudy =
          guildsData.reduce((sum, g) => sum + (g.StudyLevel || 0), 0) /
          guildsData.length;
        document.getElementById("avgNexus").textContent = avgNexus.toFixed(1);
        document.getElementById("avgStudy").textContent = avgStudy.toFixed(1);
        const totalNexusProgress = guildsData.reduce(
          (sum, g) => sum + (g.NexusProgress || 0),
          0
        );
        const totalStudyProgress = guildsData.reduce(
          (sum, g) => sum + (g.StudyProgress || 0),
          0
        );
        document.getElementById("avgNexusProgress").textContent = `+${(
          totalNexusProgress / guildsData.length
        ).toFixed(1)} today`;
        document.getElementById("avgStudyProgress").textContent = `+${(
          totalStudyProgress / guildsData.length
        ).toFixed(1)} today`;
        document.getElementById("levelsGained").textContent =
          totalNexusProgress + totalStudyProgress;
        if (dustData.formatted_dust) {
          document.getElementById("dustSpending").textContent =
            dustData.formatted_dust;
          document.getElementById("dustPrice").textContent = `â‰ˆ ${
            dustData.formatted_price || "..."
          }`;
        } else {
          document.getElementById("dustSpending").textContent = "-";
          document.getElementById("dustPrice").textContent = "No data";
        }
      }

      function updateLastUpdated(lastUpdated, baselineDate) {
        if (lastUpdated)
          document.getElementById(
            "lastUpdate"
          ).textContent = `Last updated: ${new Date(
            lastUpdated
          ).toLocaleString()}`;
        if (baselineDate)
          document.getElementById(
            "baselineDate"
          ).textContent = `Since ${baselineDate}`;
      }

      function renderGuilds() {
        const grid = document.getElementById("guildGrid");
        if (!grid) return;
        if (filteredData.length === 0) {
          grid.innerHTML =
            '<p style="grid-column: 1 / -1; text-align: center;">No guilds found.</p>';
          return;
        }
        grid.innerHTML = filteredData
          .map(
            (guild) => `
          <div class="guild-card">
            <div class="guild-name">${guild.GuildName || "N/A"}</div>
            <div class="level-info">
              <div class="level-item">
                <div class="level-label">Nexus</div>
                <div class="level-value nexus-level">${
                  guild.NexusLevel || 0
                }</div>
                <div class="daily-change ${getProgressClass(
                  guild.NexusProgress
                )}">${formatProgress(guild.NexusProgress)}</div>
              </div>
              <div class="level-item">
                <div class="level-label">Study</div>
                <div class="level-value study-level">${
                  guild.StudyLevel || 0
                }</div>
                <div class="daily-change ${getProgressClass(
                  guild.StudyProgress
                )}">${formatProgress(guild.StudyProgress)}</div>
              </div>
            </div>
          </div>`
          )
          .join("");
      }

      function getProgressClass(progress) {
        if (progress > 0) return "positive";
        if (progress < 0) return "negative";
        return "neutral";
      }

      function formatProgress(progress) {
        return `${progress > 0 ? "+" : ""}${progress || 0}`;
      }

      function filterGuilds() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        filteredData = guildsData.filter((g) =>
          (g.GuildName || "").toLowerCase().includes(searchTerm)
        );
        renderGuilds();
      }

      function aggregateDataByInterval(data, interval, selectedHours) {
        if (!data || data.length === 0) return [];
        const useDaily = interval === "daily" || selectedHours > 168;
        if (!useDaily) return data;
        const dailyData = {};
        data.forEach((entry) => {
          const date = new Date(entry.timestamp).toISOString().split("T")[0];
          if (!dailyData[date]) {
            dailyData[date] = { ...entry };
          } else {
            dailyData[date] = { ...entry }; // Keep last entry for the day
          }
        });
        return Object.values(dailyData);
      }

      function updateChart(chartType) {
        if (!historicalData?.guild_history || !chartType) return;

        const selectorList = document.getElementById(
          `${chartType}GuildSelectorList`
        );
        const selectorBtn = document.getElementById(
          `${chartType}GuildSelectorBtn`
        );
        const selectedGuilds = Array.from(
          selectorList.querySelectorAll('input[type="checkbox"]:checked')
        ).map((cb) => cb.value);

        selectorBtn.textContent = `${selectedGuilds.length} Guild${
          selectedGuilds.length !== 1 ? "s" : ""
        } Selected`;

        let chartInstance =
          chartType === "nexus" ? guildNexusChart : guildStudyChart;
        if (chartInstance) chartInstance.destroy();

        if (selectedGuilds.length === 0) return;

        const selectedHours = parseInt(
          document.querySelector(
            `#${chartType}-charts .chart-timespan-btn.active`
          )?.dataset.hours || "24"
        );
        const selectedInterval =
          document.querySelector(
            `#${chartType}-charts .guild-interval-btn.active`
          )?.dataset.interval || "hourly";

        const datasets = [];
        let allLabels = new Set();

        selectedGuilds.forEach((guildName, index) => {
          const guildHistory = historicalData.guild_history[guildName] || [];
          const now = new Date();
          const cutoffDate = new Date(
            now.getTime() - selectedHours * 60 * 60 * 1000
          );
          const filteredHistory = guildHistory.filter(
            (entry) => new Date(entry.timestamp) >= cutoffDate
          );
          const aggregatedData = aggregateDataByInterval(
            filteredHistory,
            selectedInterval,
            selectedHours
          );

          aggregatedData.forEach((d) => allLabels.add(d.timestamp));

          datasets.push({
            label: `${guildName}`,
            data: aggregatedData.map((d) => ({
              x: d.timestamp,
              y: d[chartType],
            })),
            borderColor: chartColors[index % chartColors.length],
            tension: 0.2,
            pointRadius: 2,
          });
        });

        const sortedLabels = Array.from(allLabels).sort(
          (a, b) => new Date(a) - new Date(b)
        );

        const ctx = document
          .getElementById(
            chartType === "nexus" ? "guildNexusChart" : "guildStudyChart"
          )
          .getContext("2d");

        if (chartType === "nexus") {
          guildNexusChart = new Chart(ctx, {
            type: "line",
            data: { labels: sortedLabels, datasets: datasets },
            options: chartOptions(selectedInterval, selectedHours, false),
          });
        } else {
          guildStudyChart = new Chart(ctx, {
            type: "line",
            data: { labels: sortedLabels, datasets: datasets },
            options: chartOptions(selectedInterval, selectedHours, false),
          });
        }
      }

      function updateCodexChart() {
        if (!historicalData?.market_prices?.prices?.length) return;
        const selectedHours = parseInt(
          document.querySelector("#codex-charts .codex-timespan-btn.active")
            ?.dataset.hours || "24"
        );
        const selectedInterval =
          document.querySelector("#codex-charts .codex-interval-btn.active")
            ?.dataset.interval || "hourly";
        const marketPrices = historicalData.market_prices.prices || [];
        const now = new Date();
        const cutoffDate = new Date(
          now.getTime() - selectedHours * 60 * 60 * 1000
        );
        const filteredPrices = marketPrices.filter(
          (entry) => new Date(entry.timestamp) >= cutoffDate
        );

        const dailyData = {};
        filteredPrices.forEach((entry) => {
          const date = new Date(entry.timestamp).toISOString().split("T")[0];
          if (!dailyData[date]) {
            dailyData[date] = {
              sum_buy: 0,
              sum_sell: 0,
              sum_avg: 0,
              count: 0,
              timestamp: entry.timestamp,
            };
          }
          dailyData[date].sum_buy += entry.buy_price;
          dailyData[date].sum_sell += entry.sell_price;
          dailyData[date].sum_avg += entry.average_price;
          dailyData[date].count++;
        });

        const useDaily = selectedInterval === "daily" || selectedHours > 168;
        const aggregatedData = useDaily
          ? Object.values(dailyData).map((d) => ({
              timestamp: d.timestamp,
              buy_price: d.sum_buy / d.count,
              sell_price: d.sum_sell / d.count,
              average_price: d.sum_avg / d.count,
            }))
          : filteredPrices;

        const labels = aggregatedData.map((d) => d.timestamp);

        const ctx = document.getElementById("codexPriceChart").getContext("2d");
        if (codexChart) codexChart.destroy();

        codexChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Buy Price",
                data: aggregatedData.map((d) => d.buy_price),
                borderColor: "#4ade80",
                backgroundColor: "rgba(74, 222, 128, 0.1)",
                fill: true,
                tension: 0.2,
              },
              {
                label: "Sell Price",
                data: aggregatedData.map((d) => d.sell_price),
                borderColor: "#f87171",
                backgroundColor: "rgba(248, 113, 113, 0.1)",
                fill: true,
                tension: 0.2,
              },
              {
                label: "Average Price",
                data: aggregatedData.map((d) => d.average_price),
                borderColor: "#4a9eff",
                backgroundColor: "rgba(74, 158, 255, 0.1)",
                fill: true,
                tension: 0.2,
              },
            ],
          },
          options: chartOptions(selectedInterval, selectedHours, true),
        });
      }

      function chartOptions(interval, hours, isCurrency) {
        return {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: "index" },
          scales: {
            x: {
              type: "time",
              time: {
                unit: interval === "daily" || hours > 168 ? "day" : "hour",
                tooltipFormat: "MMM d, yyyy HH:mm",
                displayFormats: { hour: "MMM d, HH:mm", day: "MMM d" },
              },
              ticks: { color: "#b3b3b3" },
              grid: { color: "#3a3a3b" },
            },
            y: {
              beginAtZero: false,
              ticks: {
                color: "#b3b3b3",
                callback: (value) =>
                  isCurrency ? formatCurrency(value) : value,
              },
              grid: { color: "#3a3a3b" },
            },
          },
          plugins: {
            legend: { labels: { color: "#f8f9fa" } },
            tooltip: {
              backgroundColor: "#1a1a1b",
              titleColor: "#f8f9fa",
              bodyColor: "#f8f9fa",
              borderColor: "#3a3a3b",
              borderWidth: 1,
              callbacks: {
                label: (c) =>
                  `${c.dataset.label}: ${
                    isCurrency ? formatCurrency(c.parsed.y) : c.parsed.y
                  }`,
              },
            },
          },
        };
      }

      function updateCurrentPriceDisplay() {
        const prices = historicalData?.market_prices?.prices;
        if (!prices || prices.length === 0) return;
        const latestPrice = prices[prices.length - 1];
        document.getElementById("currentBuyPrice").textContent = formatCurrency(
          latestPrice.buy_price
        );
        document.getElementById("currentSellPrice").textContent =
          formatCurrency(latestPrice.sell_price);
        document.getElementById("currentAvgPrice").textContent = formatCurrency(
          latestPrice.average_price
        );
        const dailyAverages = historicalData.market_prices.daily_averages || {};
        const dates = Object.keys(dailyAverages).sort();
        if (dates.length < 2) {
          document.getElementById("dailyPriceChange").textContent = "N/A";
          return;
        }
        const todayAvg = dailyAverages[dates[dates.length - 1]]?.average_price;
        const yesterdayAvg =
          dailyAverages[dates[dates.length - 2]]?.average_price;
        if (todayAvg && yesterdayAvg) {
          const change = ((todayAvg - yesterdayAvg) / yesterdayAvg) * 100;
          const el = document.getElementById("dailyPriceChange");
          el.textContent = `${change >= 0 ? "+" : ""}${change.toFixed(2)}%`;
          el.className = `price-value ${getProgressClass(change)}`;
        } else {
          document.getElementById("dailyPriceChange").textContent = "N/A";
        }
      }

      function formatCurrency(amount) {
        if (typeof amount !== "number") return amount;
        if (amount >= 1e12) return `${(amount / 1e12).toFixed(2)}T`;
        if (amount >= 1e9) return `${(amount / 1e9).toFixed(2)}B`;
        if (amount >= 1e6) return `${(amount / 1e6).toFixed(2)}M`;
        if (amount >= 1e3) return `${(amount / 1e3).toFixed(2)}K`;
        return amount.toFixed(0);
      }
    </script>
  </body>
</html>
