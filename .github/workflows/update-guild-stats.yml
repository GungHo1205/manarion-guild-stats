name: Update Guild Stats

on:
  schedule:
    # Runs every hour at minute 0 (only on master branch)
    - cron: "0 * * * *"
    # Special run at midnight UTC for baseline (only on master branch)
    - cron: "0 0 * * *"
  workflow_dispatch: # Allows manual triggering
  push:
    branches: [master, dev] # Trigger on both master and dev

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run guild stats script
        run: python guild-stats.py

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add files that exist
          git add docs/guild-data.json

          # Only add baseline file if it exists
          if [ -f "docs/daily-baseline.json" ]; then
            git add docs/daily-baseline.json
          fi

          # Only commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "Update guild stats data - $(date)"
            git push
          else
            echo "No changes to commit"
          fi

  deploy-production:
    needs: update-data
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Pull latest changes
        run: git pull origin master

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./docs"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-staging:
    needs: update-data
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull origin dev

      - name: Configure Git and deploy to gh-pages
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Fetch all branches
          git fetch origin

          # Check if gh-pages branch exists remotely
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "âœ… gh-pages branch exists, checking out..."
            git checkout gh-pages
            git pull origin gh-pages
          else
            echo "ğŸ“ Creating new gh-pages branch..."
            git checkout --orphan gh-pages
            # Remove all files from the new orphan branch
            git rm -rf . 2>/dev/null || true
            # Create a simple initial commit
            echo "# GitHub Pages" > README.md
            git add README.md
            git commit -m "Initial gh-pages setup"
            git push origin gh-pages
          fi

          # Now we're on gh-pages branch
          # Get the latest production content from dev branch's docs folder
          git checkout dev -- docs/ 2>/dev/null || echo "No docs folder found"

          # Copy production files to root (maintains production at root URL)
          if [ -d "docs" ]; then
            cp docs/* . 2>/dev/null || true
          fi

          # Create staging subdirectory and prepare staging files
          mkdir -p staging

          # Copy docs files to staging directory first
          if [ -d "docs" ]; then
            cp docs/* staging/ 2>/dev/null || true
          fi

          # Now modify the staging index.html if it exists
          if [ -f "staging/index.html" ]; then
            echo "ğŸ”§ Modifying staging index.html..."
            
            # Add staging indicators and styling
            sed -i 's/<title>Guild Stats Dashboard<\/title>/<title>[DEV] Guild Stats Dashboard<\/title>/' staging/index.html
            
            # Add staging banner CSS after the existing CSS variables
            sed -i '/--gradient-3:/a \
              --staging-bg: linear-gradient(45deg, #ff6b35, #f7931e); \
              --staging-text: #ffffff; \
              --staging-border: #ff6b35;' staging/index.html
            
            # Add staging banner HTML after the header opening
            sed -i '/<header class="header">/a \
              <div style="background: var(--staging-bg); margin: -40px -25px 20px -25px; padding: 12px 0; border-radius: 15px 15px 0 0; text-align: center; border: 2px solid var(--staging-border);"> \
                <span style="color: var(--staging-text); font-size: 1rem; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">ğŸš§ STAGING ENVIRONMENT - DEV BRANCH ğŸš§</span> \
              </div>' staging/index.html
              
            echo "âœ… Created staging version with visual indicators"
            
            # Verify staging files exist
            echo "ğŸ“ Staging directory contents:"
            ls -la staging/
          else
            echo "âš ï¸ No index.html found to modify for staging"
          fi

          # Clean up the docs directory since we've copied everything we need
          rm -rf docs 2>/dev/null || true

          # Ensure .nojekyll exists for proper GitHub Pages serving
          touch .nojekyll

          # Add all changes
          git add .

          # Show what we're about to commit
          echo "ğŸ“‹ Files to be committed:"
          git diff --staged --name-only

          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "Deploy staging to subdirectory - $(date)"
            git push origin gh-pages
            echo "âœ… Staging deployed successfully!"
            echo "ğŸŒ Production: https://gungho1205.github.io/manarion-guild-stats/"
            echo "ğŸš§ Staging: https://gungho1205.github.io/manarion-guild-stats/staging/"
          else
            echo "â„¹ï¸ No changes to deploy"
          fi

  deployment-info:
    needs: [deploy-production, deploy-staging]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment Summary:"
          echo "================================"
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "âœ… Production deployed from master branch"
            echo "ğŸ”— Production URL: https://gungho1205.github.io/manarion-guild-stats/"
          fi
          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "âœ… Staging deployed from dev branch"
            echo "ğŸ”— Staging URL: https://gungho1205.github.io/manarion-guild-stats/staging/"
            echo ""
            echo "ğŸ’¡ The staging site includes:"
            echo "   - Clear visual indicators that it's the dev environment"
            echo "   - Orange staging banner at the top"
            echo "   - [DEV] prefix in the browser title"
          fi
